// Firestore security rules for V-Serve ARTA Feedback Analytics
//
// Purpose: allow client submissions to the `feedbacks` collection while
// performing minimal validation and preventing clients from setting server
// timestamps or other sensitive fields.
//
// IMPORTANT: These rules are meant for short-term testing / staging use.
// Review and harden before deploying to production (e.g., require
// authentication, stricter validation, rate-limiting, and content checks).

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow authenticated admin users full access (optional)
    // match /users/{userId} {
    //   allow read, write: if request.auth != null && request.auth.token.admin == true;
    // }

    // Feedbacks collection: allow unauthenticated creates with validation.
    match /feedbacks/{feedbackId} {
      allow create: if isValidFeedback();
      // Do not allow direct client updates/deletes to keep data integrity.
      allow update, delete: if false;
      // Reads from the client are denied by default. If you want to allow
      // reading feedbacks from the client, change the rule below (careful).
      allow read: if false;
    }

    // Fallback: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }

    // Minimal validation function for feedback documents.
    function isValidFeedback() {
      // Required keys - must be present (can be null though)
      let required = ['clientType', 'date', 'sex', 'age', 'region', 'serviceAvailed'];
      // Ensure required keys are present
      return request.resource.data.keys().hasAll(required) &&
        // Basic types and lengths - allow null or validate if present
        (request.resource.data.clientType == null || (request.resource.data.clientType is string && request.resource.data.clientType.size() > 0 && request.resource.data.clientType.size() <= 64)) &&
        (request.resource.data.date == null || (request.resource.data.date is string && request.resource.data.date.size() <= 64)) &&
        (request.resource.data.sex == null || (request.resource.data.sex is string && request.resource.data.sex.size() <= 16)) &&
        // age may be sent as int or string (client may serialize); allow both but limit size, or null
        (request.resource.data.age == null || request.resource.data.age is int || (request.resource.data.age is string && request.resource.data.age.size() <= 4)) &&
        (request.resource.data.region == null || (request.resource.data.region is string && request.resource.data.region.size() <= 256)) &&
        (request.resource.data.serviceAvailed == null || (request.resource.data.serviceAvailed is string && request.resource.data.serviceAvailed.size() <= 512));
  // NOTE: Removed the final && true because all optional fields (ratings, suggestions, email, etc.)
  // are allowed to be present or absent without validation. The createdAt timestamp added by
  // the client SDK is also allowed.
    }

  }
}

// End of rules
