// Firestore security rules for V-Serve ARTA Feedback Analytics
//
// Purpose: allow client submissions to the `feedbacks` collection while
// performing minimal validation and preventing clients from setting server
// timestamps or other sensitive fields.
//
// IMPORTANT: These rules are meant for short-term testing / staging use.
// Review and harden before deploying to production (e.g., require
// authentication, stricter validation, rate-limiting, and content checks).

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow authenticated admin users full access (optional)
    // match /users/{userId} {
    //   allow read, write: if request.auth != null && request.auth.token.admin == true;
    // }

    // Feedbacks collection: allow unauthenticated creates with validation.
    match /feedbacks/{feedbackId} {
      allow create: if isValidFeedback();
      // Do not allow direct client updates/deletes to keep data integrity.
      allow update, delete: if false;
      // Allow reads for admin dashboard - in production, add authentication check
      // TODO: Add authentication check like: allow read: if request.auth != null;
      allow read: if true;
    }

    // System users collection for admin user management
    // TODO: Add authentication check in production: allow read, write: if request.auth != null;
    match /system_users/{userId} {
      allow read, write: if true;
    }

    // Audit logs collection for non-repudiation and accountability
    // Logs are append-only - no updates or deletes allowed to ensure integrity
    // TODO: Add authentication check in production: allow read, create: if request.auth != null;
    match /audit_logs/{logId} {
      // Anyone can create logs (services will create logs for actions)
      allow create: if true;
      // Logs should be read-only after creation (immutable audit trail)
      allow update, delete: if false;
      // Allow reads for admin dashboard viewing
      allow read: if true;
    }

    // Push notification subscriptions collection for admin notifications
    // TODO: Add authentication check in production
    match /push_subscriptions/{subscriptionId} {
      allow read, write: if true;
    }

    // Push notification queue for pending notifications
    // TODO: Add authentication check in production
    match /push_notification_queue/{notificationId} {
      allow read, write: if true;
    }

    // Alerts collection for system alerts
    // TODO: Add authentication check in production
    match /alerts/{alertId} {
      allow read, write: if true;
    }

    // Email queue collection for email notifications
    // TODO: Add authentication check in production
    match /email_queue/{emailId} {
      allow read, write: if true;
    }

    // Survey configuration collection for global survey settings
    // Settings are shared across all platforms (web, windows, android)
    // TODO: Add authentication check in production for writes: allow write: if request.auth != null;
    match /survey_config/{configId} {
      allow read: if true;  // All platforms can read config
      allow write: if true; // TODO: Restrict to authenticated admins in production
    }

    // Survey questions collection for customizable questions and section configs
    // Questions are shared across all platforms for consistent survey experience
    // TODO: Add authentication check in production for writes: allow write: if request.auth != null;
    match /survey_questions/{docId} {
      allow read: if true;  // All platforms can read questions
      allow write: if true; // TODO: Restrict to authenticated admins in production
    }

    // Fallback: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }

    // Minimal validation function for feedback documents.
    function isValidFeedback() {
      // Required keys - must be present (can be null though)
      let required = ['clientType', 'date', 'sex', 'age', 'region', 'serviceAvailed'];
      // Ensure required keys are present
      return request.resource.data.keys().hasAll(required) &&
        // Basic types and lengths - allow null or validate if present
        (request.resource.data.clientType == null || (request.resource.data.clientType is string && request.resource.data.clientType.size() > 0 && request.resource.data.clientType.size() <= 64)) &&
        (request.resource.data.date == null || (request.resource.data.date is string && request.resource.data.date.size() <= 64)) &&
        (request.resource.data.sex == null || (request.resource.data.sex is string && request.resource.data.sex.size() <= 16)) &&
        // age may be sent as int or string (client may serialize); allow both but limit size, or null
        (request.resource.data.age == null || request.resource.data.age is int || (request.resource.data.age is string && request.resource.data.age.size() <= 4)) &&
        (request.resource.data.region == null || (request.resource.data.region is string && request.resource.data.region.size() <= 256)) &&
        (request.resource.data.serviceAvailed == null || (request.resource.data.serviceAvailed is string && request.resource.data.serviceAvailed.size() <= 512));
  // NOTE: Removed the final && true because all optional fields (ratings, suggestions, email, etc.)
  // are allowed to be present or absent without validation. The createdAt timestamp added by
  // the client SDK is also allowed.
    }

  }
}

// End of rules
